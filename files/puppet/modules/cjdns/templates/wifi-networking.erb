#!/usr/bin/env bash

# vars

ssid="<%= ssid %>"
wep_pass="<%= wep_pass %>"  #WEP password (for WPA/WPA2, wpa_supplicant must be used)
txpower="1mW"               #options: NmW, N (value in dB), off, auto
rate="11M"                  #transmit rate (lower is usually more stable)
security="WEP"



# functions

start_wlan() {

    # check for internet and exit when we have it
    ping -q -c5 8.8.8.8 > /dev/null
    [[ "$?" == "0" ]] && exit

    ifconfig eth0 down
    iwconfig wlan0 txpower "$txpower"
    iwconfig wlan0 rate "$rate"

    if [[ "$security" = "WPA" ]]; then
        start_wpa
    else
        start_wep
    fi

    dhclient wlan0

}

start_wpa() {
    if [[ $(ps aux | grep -e "wpa_supplicant" | grep -v grep | wc -l | tr -s "\n") -eq 0 ]]; then

        # make sure wpa_supplicant is absent
        rm /var/run/wpa_supplicant/wlan0 2> /dev/null

        wpa_supplicant -i wlan0 -D wext -c /etc/wpa_supplicant/wpa_supplicant.conf -B

    fi
}

start_wep() {
    ifconfig wlan0 up
    iwconfig wlan0 essid "$ssid"
    iwconfig wlan0 key "$wep_pass"
}

